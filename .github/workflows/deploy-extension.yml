name: Deploy Extension to Stores

on:
  release:
    types: [published]

jobs:
  build-chrome:
    name: Build Chrome Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build Chrome extension
        run: pnpm build

      - name: Create zip
        run: pnpm -F zipper zip

      - name: Upload Chrome artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: dist-zip/*.zip
          if-no-files-found: error
          retention-days: 7

  build-firefox:
    name: Build Firefox Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build Firefox extension
        run: pnpm build:firefox

      - name: Create xpi
        run: pnpm -F zipper zip

      - name: Upload Firefox artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: dist-zip/*.xpi
          if-no-files-found: error
          retention-days: 7

  build-edge:
    name: Build Edge Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build Edge extension
        run: pnpm build:edge

      - name: Create zip
        run: pnpm -F zipper zip

      - name: Rename for Edge
        run: cd dist-zip && for f in *.zip; do mv "$f" "edge-${f}"; done

      - name: Upload Edge artifact
        uses: actions/upload-artifact@v4
        with:
          name: edge-extension
          path: dist-zip/edge-*.zip
          if-no-files-found: error
          retention-days: 7

  deploy-chrome:
    name: Deploy to Chrome Web Store
    needs: build-chrome
    runs-on: ubuntu-latest
    steps:
      - name: Download Chrome artifact
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension
          path: ./extension

      - name: Get zip file path
        id: get-zip
        run: echo "zip_path=$(ls ./extension/*.zip | head -1)" >> $GITHUB_OUTPUT

      - name: Get Chrome Web Store access token
        id: get-token
        run: |
          # Get access token using refresh token
          TOKEN_RESPONSE=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -d "client_id=${{ secrets.CHROME_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CHROME_CLIENT_SECRET }}" \
            -d "refresh_token=${{ secrets.CHROME_REFRESH_TOKEN }}" \
            -d "grant_type=refresh_token")

          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          echo "::add-mask::$ACCESS_TOKEN"
          echo "token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: Check Chrome Web Store item status
        id: check-status
        run: |
          # Pre-flight check: Query item status before attempting upload.
          # The Chrome Web Store disables uploads when an item is pending review,
          # ready to publish, or deleted. Rather than failing the workflow when
          # this happens, we detect it early and skip the upload gracefully.
          # This results in a warning (yellow status) instead of a failure (red).

          EXTENSION_ID="ihbcgmgbibicnkinndgpnmphahijahio"

          STATUS_RESPONSE=$(curl -s -X GET \
            "https://chromewebstore.googleapis.com/v2/publishers/me/items/$EXTENSION_ID:fetchStatus" \
            -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}")

          echo "Status response:"
          echo "$STATUS_RESPONSE" | jq .

          # Check if item has a submitted revision pending review
          SUBMITTED_STATE=$(echo "$STATUS_RESPONSE" | jq -r '.submittedItemRevisionStatus.itemState // empty')

          if [ "$SUBMITTED_STATE" = "PENDING_REVIEW" ]; then
            echo "::warning::Chrome Web Store item is currently pending review. Skipping upload."
            echo "skip_upload=true" >> $GITHUB_OUTPUT
          else
            echo "Item is updatable, proceeding with upload."
            echo "skip_upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Chrome Web Store
        if: steps.check-status.outputs.skip_upload != 'true'
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: ${{ steps.get-zip.outputs.zip_path }}
          extension-id: ihbcgmgbibicnkinndgpnmphahijahio
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true

      - name: Report skipped upload
        if: steps.check-status.outputs.skip_upload == 'true'
        run: |
          echo "## ⚠️ Chrome Web Store Upload Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The extension is currently **pending review** in the Chrome Web Store." >> $GITHUB_STEP_SUMMARY
          echo "Upload was skipped to avoid failure. The new version will need to be uploaded manually after the review completes, or wait for the next release." >> $GITHUB_STEP_SUMMARY

  deploy-firefox:
    name: Deploy to Firefox Add-ons
    needs: build-firefox
    runs-on: ubuntu-latest
    steps:
      - name: Download Firefox artifact
        uses: actions/download-artifact@v4
        with:
          name: firefox-extension
          path: ./extension

      - name: Get xpi file path
        id: get-xpi
        run: echo "xpi_path=$(ls ./extension/*.xpi | head -1)" >> $GITHUB_OUTPUT

      - name: Upload to Firefox Add-ons
        uses: browser-actions/release-firefox-addon@v0.1.3
        with:
          addon-id: localstorageexplorer@example.com
          addon-path: ${{ steps.get-xpi.outputs.xpi_path }}
          auth-api-issuer: ${{ secrets.FIREFOX_JWT_ISSUER }}
          auth-api-secret: ${{ secrets.FIREFOX_JWT_SECRET }}
          release-note: "Bug fixes and improvements"

  deploy-edge:
    name: Deploy to Microsoft Edge Add-ons
    needs: build-edge
    runs-on: ubuntu-latest
    steps:
      - name: Download Edge artifact
        uses: actions/download-artifact@v4
        with:
          name: edge-extension
          path: ./extension

      - name: Get zip file path
        id: get-zip
        run: echo "zip_path=$(ls ./extension/*.zip | head -1)" >> $GITHUB_OUTPUT

      - name: Upload to Edge Add-ons
        uses: wdzeng/edge-addon@v2
        with:
          product-id: d02c3d9e-6bba-428a-ace7-303705dd14ab
          zip-path: ${{ steps.get-zip.outputs.zip_path }}
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          api-key: ${{ secrets.EDGE_API_KEY }}

  upload-release-assets:
    name: Upload Release Assets
    needs: [build-chrome, build-firefox, build-edge]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure
        run: ls -R ./artifacts

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/chrome-extension/*.zip
            ./artifacts/firefox-extension/*.xpi
            ./artifacts/edge-extension/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
